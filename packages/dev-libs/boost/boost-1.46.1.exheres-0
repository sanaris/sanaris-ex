# Copyright 2008, 2009, 2010 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# 
# I'm using it as example ---sanaris


MY_PNV=${PN}_$(ever replace_all '_')

require cmake sourceforge

SUMMARY="Boost Libraries for C++"
HOMEPAGE="http://www.${PN}.org"
DOWNLOADS = "http://gitorious.org/boost/cmake/archive-tarball/cmake-1.46.1"

#DOWNLOADS+=" http://dev.exherbo.org/~tgurr/distfiles/${PN}/${PNV}-cmake.patch.bz2"

LICENCES="freedist Boost-1.0"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="debug doc"

# All tests are slow, run only slow tests
RESTRICT="test"

DEPENDENCIES="
    build:
        doc? (
            app-arch/unzip      [[ note = [ tools/build/CMake/BoostDocs.cmake ] ]]
            app-doc/doxygen     [[ note = [ tools/build/CMake/BoostDocs.cmake ] ]]
            dev-libs/libxslt    [[ note = [ tools/build/CMake/BoostDocs.cmake ] ]]
        )   [[ note = [ tools/build/CMake/BoostDocs.cmake ] ]]
    build+run:
        dev-lang/python:=
        dev-libs/expat
        dev-libs/icu
"

REMOTE_IDS="freshmeat:${PN}"

UPSTREAM_CHANGELOG="${HOMEPAGE}/users/news/version_${PV//./_}"

WORK="${WORKBASE}/${MY_PNV}"

DEFAULT_SRC_PREPARE_PATCHES=(
#    "${WORKBASE}/${PNV}-cmake.patch"
)

CMAKE_SRC_CONFIGURE_PARAMS=(
    -DENABLE_MULTI_THREADED:BOOL=TRUE
    -DENABLE_SINGLE_THREADED:BOOL=TRUE
    -DENABLE_SHARED:BOOL=TRUE
    -DENABLE_STATIC:BOOL=FALSE
    -DINSTALL_VERSIONED:BOOL=FALSE
    -DMPI_FOUND:BOOL=FALSE # Avoid automagic dependency
    -DWITH_VALGRIND:BOOL=FALSE # Run tests under valgrind
)
CMAKE_SRC_CONFIGURE_OPTIONS=(
    'doc DOCUMENTATION'
    'doc DOCUMENTATION_HTML'
)
CMAKE_SRC_CONFIGURE_OPTION_ENABLES=( DEBUG )

# FIXME:
# Some tests still need their CMakeLists.txt written, current cmake patch
# isn't quite complete
# To build tests: cmake -DBUILD_TESTS:BOOL=ALL
# To run tests:   src_test_expensive() { ctest ; }

src_install() {
    cmake_src_install

    edo find "${IMAGE}" -type d -empty -delete

    if option doc ; then
        # FIXME Should really be handled by boosts buildsystem
        local f
        find doc/ libs/ -depth -iname 'test' -o -iname 'src' -o -iname 'CMakeLists.txt' -o -iname '*.cmake' -o -iname 'Jamfile.v2' -o -iname 'proj' -o -iname '*.vcproj' | while read f ; do
            edo rm -r "${f}"
        done

        insinto /usr/share/doc/${PNVR}/html
        doins -r doc libs more

        dosym /usr/include/${PN} /usr/share/doc/${PNVR}/html/${PN}
    fi
}

